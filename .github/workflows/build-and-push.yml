name: Detect new releases and build `linux/arm64` Docker images

on:
  push:
    branches:
    - main
  pull_request:
    types:
    - opened
    - synchronize
    - reopened
  schedule:
    # The official docs: "The schedule event can be delayed during periods of high loads of
    # GitHub Actions workflow runs. High load times include the start of every hour. To decrease
    # the chance of delay, schedule your workflow to run at a different time of the hour."
    # 42 is for https://en.wikipedia.org/wiki/42_(number)#The_Hitchhiker's_Guide_to_the_Galaxy
    - cron: '42 * * * *'

env:
  GH_REPOSITORY: restic/restic
  DOCKERHUB_REPOSITORY: ${{ github.actor }}/restic
  PUSH_IMAGE: ${{ github.event_name == 'schedule' }}

concurrency:
  group: ${{ github.repository }}/${{ github.workflow }}/${{ github.event_name }}
  cancel-in-progress: true

jobs:
  prepare-scripts:
    name: Upload scripts
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Tar scripts
        run: |
          tar -cvf /tmp/artifacts.tar ./scripts/*
      - name: Upload scripts
        uses: actions/upload-artifact@v3
        with:
          name: ${{ github.repository_owner }}_${{ github.event.repository.name }}_artifacts
          path: /tmp/artifacts.tar
  tags:
    runs-on: ubuntu-latest
    outputs:
      json: ${{ steps.unpublished.outputs.tags }}
    steps:
      - name: Checkout target repository
        uses: actions/checkout@v3
        with:
          repository: ${{ env.GH_REPOSITORY }}
          fetch-depth: 0
      - name: Get unpublished tags
        id: unpublished
        uses: wooseopkim/unpublished-tags@v2
        with:
          dockerhub-repository: ${{ env.DOCKERHUB_REPOSITORY }}
          first-tag: v0.7.2
  build:
    needs: [tags]
    if: needs.tags.out.puts.unpublished != '[]' && needs.tags.out.puts.unpublished != ''
    uses: wooseopkim/publish-tags/.github/workflows/workflow.yml@main
    with:
      tags: ${{ needs.tags.outputs.unpublished }}
      github-repository: ${{ env.GH_REPOSITORY }}
      dockerhub-repository: ${{ env.DOCKERHUB_REPOSITORY }}
      pre-build-script: |
        ~/artifacts/scripts/build_binary
      post-build-script: |
        ~/artifacts/scripts/verify_image $IMAGE $TAG
      push-image: ${{ github.event_name == 'schedule' }}
      platforms: linux/arm64
      dockerfile: docker/Dockerfile
